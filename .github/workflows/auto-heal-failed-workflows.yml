name: Auto-Heal Failed Workflows

on:
  workflow_run:
    workflows:
      - Deploy Backend to GCP Cloud Run
      - Purge Cloudflare Cache
      - Scheduled MongoDB Export Backup
      - Security Posture Checks
    types:
      - completed

permissions:
  actions: write
  contents: read
  issues: write

concurrency:
  group: auto-heal-${{ github.event.workflow_run.id }}
  cancel-in-progress: true

jobs:
  rerun-once:
    name: Auto rerun failed workflow once
    if: >-
      ${{
        github.event.workflow_run.conclusion == 'failure' &&
        github.event.workflow_run.run_attempt == 1 &&
        github.event.workflow_run.head_branch == 'main' &&
        github.event.workflow_run.event != 'pull_request'
      }}
    runs-on: ubuntu-latest
    steps:
      - name: Re-run failed workflow
        uses: actions/github-script@v8
        with:
          script: |
            const run = context.payload.workflow_run;
            await github.request("POST /repos/{owner}/{repo}/actions/runs/{run_id}/rerun", {
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: run.id,
            });
            core.info(`Triggered auto-rerun for workflow run ${run.id} (${run.name})`);

  create-or-update-incident:
    name: Open or update incident issue
    if: >-
      ${{
        github.event.workflow_run.conclusion == 'failure' &&
        github.event.workflow_run.run_attempt > 1 &&
        github.event.workflow_run.head_branch == 'main' &&
        github.event.workflow_run.event != 'pull_request'
      }}
    runs-on: ubuntu-latest
    steps:
      - name: Open or update issue
        uses: actions/github-script@v8
        with:
          script: |
            const run = context.payload.workflow_run;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = `[Auto-Heal] ${run.name} failing on main`;
            const body = [
              "## Automated Incident Report",
              "",
              "The workflow is still failing after one automated rerun attempt.",
              "",
              `- Workflow: **${run.name}**`,
              `- Branch: **${run.head_branch}**`,
              `- Event: **${run.event}**`,
              `- Run attempt: **${run.run_attempt}**`,
              `- Run URL: ${run.html_url}`,
              `- Commit: \`${run.head_sha}\``,
            ].join("\n");

            const { data: openIssues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open",
              per_page: 100,
            });
            const existing = openIssues.find((issue) => issue.title === title);

            if (existing) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: existing.number,
                body: `Workflow failed again.\n\n${body}`,
              });
              core.info(`Updated existing incident issue #${existing.number}`);
            } else {
              const { data: created } = await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
              });
              core.info(`Created incident issue #${created.number}`);
            }

  close-incident-on-recovery:
    name: Close incident on recovery
    if: >-
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.head_branch == 'main' &&
        github.event.workflow_run.event != 'pull_request'
      }}
    runs-on: ubuntu-latest
    steps:
      - name: Close matching incident issue if open
        uses: actions/github-script@v8
        with:
          script: |
            const run = context.payload.workflow_run;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = `[Auto-Heal] ${run.name} failing on main`;

            const { data: openIssues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open",
              per_page: 100,
            });
            const existing = openIssues.find((issue) => issue.title === title);
            if (!existing) {
              core.info("No open incident issue to close.");
              return;
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: existing.number,
              body: `Workflow recovered successfully: ${run.html_url}`,
            });
            await github.rest.issues.update({
              owner,
              repo,
              issue_number: existing.number,
              state: "closed",
            });
            core.info(`Closed incident issue #${existing.number}`);
