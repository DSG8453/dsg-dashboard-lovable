name: Purge Cloudflare Cache

on:
  workflow_run:
    workflows:
      - Deploy Backend to GCP Cloud Run
    types:
      - completed
  workflow_dispatch:
    inputs:
      purge_everything:
        description: "Purge the entire Cloudflare zone cache"
        required: false
        type: boolean
        default: false
      urls:
        description: "Comma or newline separated URLs to purge"
        required: false
        type: string

permissions:
  contents: read

concurrency:
  group: cloudflare-cache-purge-${{ github.ref }}
  cancel-in-progress: true

jobs:
  purge:
    name: Purge Cloudflare cache
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Resolve purge payload
        id: payload
        env:
          INPUT_PURGE_EVERYTHING: ${{ inputs.purge_everything }}
          INPUT_URLS: ${{ inputs.urls }}
          DEFAULT_PURGE_EVERYTHING: ${{ vars.CLOUDFLARE_PURGE_EVERYTHING }}
          DEFAULT_URLS: ${{ vars.CLOUDFLARE_PURGE_URLS }}
        run: |
          set -euo pipefail
          purge_everything_flag="${INPUT_PURGE_EVERYTHING:-}"
          if [ -z "${purge_everything_flag}" ]; then
            purge_everything_flag="${DEFAULT_PURGE_EVERYTHING:-false}"
          fi

          urls_raw="${INPUT_URLS:-${DEFAULT_URLS:-}}"

          if [ "${purge_everything_flag}" = "true" ]; then
            echo 'payload={"purge_everything":true}' >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          if [ -z "${urls_raw}" ]; then
            echo "No URLs provided for selective purge. Set input 'urls' or repo variable CLOUDFLARE_PURGE_URLS." >&2
            exit 1
          fi

          export RAW_URLS="${urls_raw}"
          payload="$(python - <<'PY'
import json
import os
import re

raw = os.environ.get("RAW_URLS", "")
parts = [p.strip() for p in re.split(r"[\n,]", raw) if p.strip()]
if not parts:
    raise SystemExit("No valid URLs found for selective purge")
print(json.dumps({"files": parts}))
PY
)"
          echo "payload=${payload}" >> "${GITHUB_OUTPUT}"

      - name: Purge Cloudflare cache with retry
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          PAYLOAD: ${{ steps.payload.outputs.payload }}
        run: |
          set -euo pipefail
          if [ -z "${CLOUDFLARE_API_TOKEN}" ] || [ -z "${CLOUDFLARE_ZONE_ID}" ]; then
            echo "Missing required Cloudflare secrets: CLOUDFLARE_API_TOKEN and CLOUDFLARE_ZONE_ID" >&2
            exit 1
          fi

          api_url="https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/purge_cache"
          response_file="$(mktemp)"

          for attempt in 1 2 3 4; do
            status_code="$(curl -sS -o "${response_file}" -w "%{http_code}" \
              -X POST "${api_url}" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data "${PAYLOAD}")"

            if [ "${status_code}" -ge 200 ] && [ "${status_code}" -lt 300 ]; then
              if python - "${response_file}" <<'PY'
import json
import sys
with open(sys.argv[1], "r", encoding="utf-8") as f:
    data = json.load(f)
if not data.get("success"):
    raise SystemExit(1)
PY
              then
                echo "Cloudflare purge completed successfully."
                rm -f "${response_file}"
                exit 0
              fi
            fi

            sleep $((attempt * 2))
          done

          echo "Cloudflare purge failed after retries."
          cat "${response_file}"
          rm -f "${response_file}"
          exit 1
