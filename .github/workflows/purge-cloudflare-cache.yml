name: Purge Cloudflare Cache

on:
  workflow_dispatch:
  workflow_run:
    workflows:
      - Deploy Backend to GCP Cloud Run
    types:
      - completed

permissions:
  contents: read

jobs:
  purge:
    name: Purge Cloudflare cache
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Resolve purge payload from repository variables
        id: payload
        shell: bash
        env:
          CLOUDFLARE_PURGE_EVERYTHING: ${{ vars.CLOUDFLARE_PURGE_EVERYTHING }}
          CLOUDFLARE_PURGE_URLS: ${{ vars.CLOUDFLARE_PURGE_URLS }}
        run: |
          set -euo pipefail
          purge_everything_flag="${CLOUDFLARE_PURGE_EVERYTHING:-false}"
          urls_raw="${CLOUDFLARE_PURGE_URLS:-}"

          if [ "${purge_everything_flag}" = "true" ]; then
            echo 'payload={"purge_everything":true}' >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          if [ -z "${urls_raw}" ]; then
            echo "No URLs provided for selective purge. Set input 'urls' or repo variable CLOUDFLARE_PURGE_URLS." >&2
            exit 1
          fi

          export RAW_URLS="${urls_raw}"
          payload="$(python3 -c 'import json, os, re; raw=os.environ.get("RAW_URLS",""); parts=[p.strip() for p in re.split(r"[\\n,]", raw) if p.strip()]; assert parts, "No valid URLs found for selective purge"; print(json.dumps({"files": parts}))')"
          echo "payload=${payload}" >> "${GITHUB_OUTPUT}"

      - name: Purge Cloudflare cache with retry
        shell: bash
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          PAYLOAD: ${{ steps.payload.outputs.payload }}
        run: |
          set -euo pipefail
          if [ -z "${CLOUDFLARE_API_TOKEN}" ] || [ -z "${CLOUDFLARE_ZONE_ID}" ]; then
            echo "Missing required Cloudflare secrets: CLOUDFLARE_API_TOKEN and CLOUDFLARE_ZONE_ID" >&2
            exit 1
          fi

          api_url="https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/purge_cache"
          response_file="$(mktemp)"

          for attempt in 1 2 3 4; do
            status_code="$(curl -sS -o "${response_file}" -w "%{http_code}" \
              -X POST "${api_url}" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data "${PAYLOAD}")"

            if [ "${status_code}" -ge 200 ] && [ "${status_code}" -lt 300 ]; then
              if python3 -c 'import json, sys; data=json.load(open(sys.argv[1], "r", encoding="utf-8")); raise SystemExit(0 if data.get("success") else 1)' "${response_file}"; then
                echo "Cloudflare purge completed successfully."
                rm -f "${response_file}"
                exit 0
              fi
            fi

            sleep $((attempt * 2))
          done

          echo "Cloudflare purge failed after retries."
          cat "${response_file}"
          rm -f "${response_file}"
          exit 1
